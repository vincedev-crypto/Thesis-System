<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${subject.subjectName} + ' - Classroom'">Subject Classroom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/subject-classroom.css}">
</head>
<body>
<div class="teacher-layout">
    <div th:replace="teacher-nav :: teacherNav"></div>

    <div class="teacher-content-wrapper">
        <div class="main-container">
            <div class="mb-3">
                <a th:href="@{/teacher/homepage}" class="btn btn-sm btn-outline-secondary mb-2">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>

            <div class="classroom-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                    <div>
                        <h4 class="fw-bold mb-1" style="color:#7a1022;">
                            <i class="bi bi-book me-2"></i>
                            <span th:text="${subject.subjectName}">Subject Name</span>
                        </h4>
                        <p class="text-muted small mb-2"
                           th:if="${subject.description != null && !subject.description.isEmpty()}"
                           th:text="${subject.description}">Subject Description</p>
                        <div class="mt-2">
                            <span class="stat-badge students">
                                <i class="bi bi-people"></i>
                                <span th:text="${#lists.size(enrolledStudents)}">0</span> Students
                            </span>
                            <span class="stat-badge submissions">
                                <i class="bi bi-file-text"></i>
                                <span th:text="${classroomStats.totalSubmissions}">0</span> Submissions
                            </span>
                            <span class="stat-badge submissions">
                                <i class="bi bi-check-circle"></i>
                                <span th:text="${classroomStats.gradedCount}">0</span> Graded
                            </span>
                            <span class="stat-badge submissions">
                                <i class="bi bi-clock-history"></i>
                                <span th:text="${classroomStats.pendingCount}">0</span> Pending
                            </span>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#enrollModal">
                            <i class="bi bi-person-plus me-1"></i> Enroll Students
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                                th:disabled="${#lists.isEmpty(enrolledStudents) || #lists.isEmpty(uploadedExams)}"
                                data-bs-toggle="modal" data-bs-target="#distributeQuizModal">
                            <i class="bi bi-send-check me-1"></i> Distribute Quiz
                        </button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="section-title mb-0" style="border-bottom:none; padding-bottom:0;">
                        <i class="bi bi-clipboard-check"></i> Distributed Exam Tracking
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success-subtle text-success border border-success-subtle"
                              th:text="${distributedSubmittedCount} + ' Students Submitted'">0 Students Submitted</span>
                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle"
                              th:text="${distributedNotSubmittedCount} + ' Pending'">0 Pending</span>
                    </div>
                </div>
                <div style="height:1px; background:#eadfce; margin:1rem 0;"></div>

                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                    <small class="text-muted">Use each quiz row action to view submitted, not submitted, and queued students for that specific quiz.</small>
                </div>

                <div th:if="${quizDistributionSummary != null && !quizDistributionSummary.isEmpty()}" class="mb-3">
                    <div class="small fw-semibold text-muted mb-2">Per Quiz Submission Status</div>
                    <div class="table-responsive">
                        <table class="student-list-table">
                            <thead>
                            <tr>
                                <th>Quiz</th>
                                <th>Type</th>
                                <th>Time Limit</th>
                                <th>Deadline</th>
                                <th>Assigned</th>
                                <th>Submitted</th>
                                <th>Not Submitted</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="quiz : ${quizDistributionSummary}">
                                <td>
                                    <div class="fw-semibold" th:text="${quiz.examName}">Quiz Name</div>
                                    <small class="text-muted" th:text="${quiz.subject}">Subject</small>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="${quiz.activityType == 'Exam' ? 'bg-danger' : 'bg-primary'}"
                                          th:text="${quiz.activityType}">Type</span>
                                </td>
                                <td th:text="${quiz.timeLimit} + ' min'">0 min</td>
                                <td th:text="${quiz.deadline}">Deadline</td>
                                <td><span class="badge bg-secondary" th:text="${quiz.assignedCount}">0</span></td>
                                <td><span class="badge bg-success" th:text="${quiz.submittedCount}">0</span></td>
                                <td><span class="badge bg-warning text-dark" th:text="${quiz.notSubmittedCount}">0</span></td>
                                <td>
                                    <span class="badge bg-success"
                                          th:if="${quiz.assignedCount > 0 and quiz.submittedCount == quiz.assignedCount}">Completed</span>
                                    <span class="badge bg-primary"
                                          th:if="${quiz.submittedCount > 0 and quiz.submittedCount < quiz.assignedCount}">Ongoing</span>
                                    <span class="badge bg-secondary"
                                          th:if="${quiz.submittedCount == 0}">Waiting for submissions</span>
                                </td>
                                <td>
                                                <a class="btn btn-sm btn-outline-primary"
                                                    th:href="@{/teacher/subject-classroom/{id}/distribution-students(id=${subject.id},filterExamName=${quiz.filterExamName},filterActivityType=${quiz.filterActivityType},filterTimeLimit=${quiz.filterTimeLimit},filterDeadline=${quiz.filterDeadline})}">
                                        <i class="bi bi-people me-1"></i> View Students
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${distributionTracker == null || distributionTracker.isEmpty()}" class="empty-state">
                    <i class="bi bi-hourglass-split"></i>
                    <p class="mb-1 fw-semibold small">No quiz assigned yet.</p>
                    <small class="text-muted">Once you distribute an exam, its subject, time limit, and deadline will appear here.</small>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title mb-0" style="border-bottom:none; padding-bottom:0;">
                    <i class="bi bi-people-fill"></i> Enrolled Students
                </div>
                <div style="height:1px; background:#eadfce; margin:1rem 0;"></div>

                <div th:if="${#lists.isEmpty(enrolledStudents)}" class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p class="mb-1 fw-semibold small">No students enrolled yet.</p>
                    <small class="text-muted">Click "Enroll Students" to add students to this classroom.</small>
                </div>

                <div th:if="${!#lists.isEmpty(enrolledStudents)}" class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <small class="text-muted">Manage and search all enrolled students in a dedicated list page.</small>
                    <a class="btn btn-sm btn-outline-primary"
                       th:href="@{/teacher/subject-classroom/{id}/enrolled-students(id=${subject.id})}">
                        <i class="bi bi-list-ul me-1"></i> View Enrolled Students List
                    </a>
                </div>
            </div>

            <div class="section-card">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom flex-wrap gap-2">
                    <div class="section-title mb-0" style="border-bottom:none; padding-bottom:0; margin-bottom:0;">
                        <i class="bi bi-clipboard-data"></i> Students &amp; Grades
                    </div>
                    <input type="text" id="classroomStudentSearch" class="form-control form-control-sm"
                           placeholder="ðŸ”Ž Search student name or email..." style="max-width:260px;">
                </div>

                <div th:if="${classroomStudentSummary == null || classroomStudentSummary.isEmpty()}" class="empty-state">
                    <i class="bi bi-graph-up"></i>
                    <p class="mb-1 fw-semibold small">No submissions yet.</p>
                    <small class="text-muted">Submissions in this classroom will appear here.</small>
                </div>

                <div id="classroomStudentPanelList" th:if="${classroomStudentSummary != null && !classroomStudentSummary.isEmpty()}">
                    <div th:each="student,si : ${classroomStudentSummary}" class="student-panel"
                         th:attr="data-search-key=${#strings.toLowerCase(student.studentName) + ' ' + #strings.toLowerCase(student.studentEmail)}">

                        <div class="student-panel-header"
                             th:attr="data-bs-toggle='collapse',
                                      data-bs-target='#classroomCollapse' + ${si.index},
                                      aria-expanded='false',
                                      aria-controls='classroomCollapse' + ${si.index}">
                            <div class="d-flex align-items-center gap-3">
                                <div class="student-avatar" th:text="${#strings.substring(student.studentName, 0, 1)}">S</div>
                                <div>
                                    <div class="fw-semibold" th:text="${student.studentName}">Student Name</div>
                                    <div class="text-muted small">
                                        <i class="bi bi-envelope me-1"></i>
                                        <span th:text="${student.studentEmail}">email@example.com</span>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                                <span class="badge bg-primary rounded-pill"
                                      th:text="${student.totalSubmissions} + ' submission' + (${student.totalSubmissions != 1} ? 's' : '')">0 submissions</span>
                                <span class="badge bg-success" th:if="${student.gradedCount > 0}"
                                      th:text="${student.gradedCount} + ' graded'">0 graded</span>
                                <span class="badge bg-warning text-dark" th:if="${student.pendingCount > 0}"
                                      th:text="${student.pendingCount} + ' pending'">0 pending</span>
                                <span class="fw-semibold text-secondary" th:if="${student.gradedCount > 0}"
                                      th:text="'Avg: ' + ${student.averageScore} + '%'">Avg: 0%</span>
                                <i class="bi bi-chevron-down text-muted"></i>
                            </div>
                        </div>

                        <div th:id="'classroomCollapse' + ${si.index}" class="collapse">
                            <div class="p-3">
                                <div th:if="${student.submissions == null || student.submissions.isEmpty()}" class="text-center text-muted py-3">
                                    <i class="bi bi-inbox"></i> No submissions yet.
                                </div>

                                <div th:if="${student.submissions != null && !student.submissions.isEmpty()}" class="table-responsive">
                                    <table class="table table-sm table-hover align-middle mb-0 sub-inner-table">
                                        <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Exam</th>
                                            <th>Type</th>
                                            <th>Score</th>
                                            <th>Status</th>
                                            <th>Submitted</th>
                                            <th>Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="sub,idx : ${student.submissions}">
                                            <td class="text-muted" th:text="${idx.count}">1</td>
                                            <td>
                                                <span class="fw-semibold" th:text="${sub.examName}">Exam</span>
                                                <span class="badge bg-light text-dark border ms-1" th:text="${sub.subject}">Subject</span>
                                            </td>
                                            <td>
                                                <span class="badge" th:classappend="${sub.activityType == 'Exam' ? 'bg-danger' : 'bg-primary'}"
                                                      th:text="${sub.activityType}">Type</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary" th:text="${sub.score + ' / ' + sub.totalQuestions}">0 / 0</span>
                                                <span class="text-muted ms-1"
                                                      th:text="'(' + ${#numbers.formatDecimal(sub.percentage, 1, 1)} + '%)'">(0%)</span>
                                            </td>
                                            <td>
                                                <span th:if="${sub.graded}" class="badge bg-success">Graded</span>
                                                <span th:unless="${sub.graded}" class="badge bg-warning text-dark">Pending</span>
                                            </td>
                                            <td>
                                                <small class="text-nowrap" th:text="${#temporals.format(sub.submittedAt, 'MMM dd, yyyy HH:mm')}">Date</small>
                                            </td>
                                            <td>
                                                <div class="d-flex gap-1 flex-wrap">
                                                    <a th:href="@{/teacher/view-result/{id}(id=${sub.id})}" class="btn btn-xs btn-primary" title="View">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <a th:unless="${sub.isGraded()}"
                                                       th:href="@{/teacher/grade/{id}(id=${sub.id})}"
                                                       class="btn btn-xs btn-warning" title="Grade">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Centered Distribute Quiz Modal (student list + exam settings) -->
<div class="modal fade" id="distributeQuizModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #7a1022 0%, #5f0d1a 100%); border-bottom: 2px solid #d4a32a;">
                <h5 class="modal-title">
                    <i class="bi bi-send-check-fill me-2"></i>Distribute Quiz
                    <span class="badge ms-2" style="background:#d4a32a;color:#3a0a10;" id="modalSelectedCount">0 selected</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div th:if="${#lists.isEmpty(enrolledStudents)}" class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    No students enrolled in this classroom.
                </div>
                <div th:if="${#lists.isEmpty(uploadedExams)}" class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    No processed exams found for this subject. You can only distribute quizzes from this subject.
                </div>

                <form id="distributeQuizForm" th:action="@{/teacher/distribute-selected}" method="post">
                    <input type="hidden" name="subjectId" th:value="${subject.id}">

                    <div class="row g-3">
                        <div class="col-lg-5">
                            <div class="border rounded-3 p-3 h-100 bg-light-subtle">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-semibold mb-0">Select Students</label>
                                    <div class="form-check mb-0">
                                        <input class="form-check-input" type="checkbox" id="modalSelectAllStudents">
                                        <label class="form-check-label small" for="modalSelectAllStudents">Select all</label>
                                    </div>
                                </div>
                                <div class="small text-muted mb-2">Choose all or specific students to receive this quiz.</div>
                                <div class="border rounded p-2 bg-white" style="max-height: 320px; overflow:auto;">
                                    <div th:if="${#lists.isEmpty(enrolledStudents)}" class="small text-muted py-2">No students available.</div>
                                    <div class="form-check py-1" th:each="student : ${enrolledStudents}">
                                        <input class="form-check-input modal-student-checkbox" type="checkbox"
                                               name="selectedStudents"
                                               th:id="'sel_' + ${student.id}"
                                               th:value="${student.studentEmail}">
                                        <label class="form-check-label" th:for="'sel_' + ${student.id}">
                                            <span class="fw-semibold" th:text="${student.studentName}">Student</span>
                                            <small class="text-muted d-block" th:text="${student.studentEmail}">email</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <div class="border rounded-3 p-3 h-100">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold small"><i class="bi bi-journal-text me-1"></i>Processed Exam</label>
                                        <select id="examSelect" name="examId" class="form-select form-select-sm" required
                                            th:disabled="${#lists.isEmpty(uploadedExams)}">
                                            <option value="">-- Select exam --</option>
                                            <optgroup th:if="${uploadedExams != null && !#lists.isEmpty(uploadedExams)}"
                                                      th:label="'This Subject: ' + ${subject.subjectName}">
                                                <option th:each="exam : ${uploadedExams}"
                                                        th:value="${exam.examId}"
                                                        th:text="${exam.examName + ' â€¢ ' + exam.activityType}"
                                                        th:attr="data-question-count=${#lists.size(exam.questions)}"></option>
                                            </optgroup>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold small"><i class="bi bi-list-ol me-1"></i>Questions to Distribute</label>
                                        <input type="number" name="questionCount" id="questionCountInput"
                                               class="form-control form-control-sm"
                                               min="1" value="1" required>
                                        <div class="form-text" id="questionCountHint">Select an exam first.</div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold small"><i class="bi bi-clock me-1"></i>Time Limit</label>
                                        <select name="timeLimit" class="form-select form-select-sm" required>
                                            <option value="15">15 minutes</option>
                                            <option value="30">30 minutes</option>
                                            <option value="45">45 minutes</option>
                                            <option value="60" selected>1 hour</option>
                                            <option value="90">1.5 hours</option>
                                            <option value="120">2 hours</option>
                                            <option value="150">2.5 hours</option>
                                            <option value="180">3 hours</option>
                                        </select>
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold small"><i class="bi bi-bar-chart me-1"></i>Difficulty Distribution (%)</label>
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <label class="form-label small text-success mb-1">Easy</label>
                                                <input type="number" name="easyPercent" class="form-control form-control-sm"
                                                       min="0" max="100" value="30" required oninput="validatePct(this)">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label small text-warning mb-1">Medium</label>
                                                <input type="number" name="mediumPercent" class="form-control form-control-sm"
                                                       min="0" max="100" value="50" required oninput="validatePct(this)">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label small text-danger mb-1">Hard</label>
                                                <input type="number" name="hardPercent" class="form-control form-control-sm"
                                                       min="0" max="100" value="20" required oninput="validatePct(this)">
                                            </div>
                                        </div>
                                        <div class="alert alert-danger mt-2 py-1 d-none pct-error small mb-0">
                                            <i class="bi bi-exclamation-triangle-fill me-1"></i>Total must equal 100%
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold small"><i class="bi bi-calendar-event me-1"></i>Deadline</label>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <select class="form-select form-select-sm deadline-preset" onchange="applyDeadlinePreset(this)">
                                                    <option value="1">1 hour from now</option>
                                                    <option value="3">3 hours from now</option>
                                                    <option value="6">6 hours from now</option>
                                                    <option value="12">12 hours from now</option>
                                                    <option value="24" selected>1 day from now</option>
                                                    <option value="48">2 days from now</option>
                                                    <option value="72">3 days from now</option>
                                                    <option value="168">1 week from now</option>
                                                    <option value="custom">Custom date/time...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <input type="datetime-local" name="deadline" class="form-control form-control-sm deadline-input" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="manageSelectedQuizBtn" class="btn btn-outline-primary">
                    <i class="bi bi-pencil-square me-1"></i>Manage Quiz
                </button>
                <button type="submit" form="distributeQuizForm" class="btn btn-primary text-white" id="distributeSubmitBtn"
                        th:disabled="${#lists.isEmpty(enrolledStudents) || #lists.isEmpty(uploadedExams)}">
                    <i class="bi bi-send-fill me-1"></i>Distribute Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="enrollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #7a1022 0%, #5f0d1a 100%); border-bottom: 2px solid #d4a32a;">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Enroll Students</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/teacher/enroll-student}" method="post">
                    <input type="hidden" name="subjectId" th:value="${subject.id}">
                    <div class="mb-3">
                        <label class="form-label">Select Student</label>
                        <input type="text" id="enrollStudentSearch" class="form-control mb-2"
                               placeholder="ðŸ”Ž Search student via email">
                        <small class="text-muted d-block mb-2">Note: Search student via email.</small>
                        <select id="enrollStudentSelect" name="studentEmail" class="form-select" required>
                            <option value="">-- Select a student --</option>
                            <option th:each="student : ${allStudents}"
                                    th:value="${student.email}"
                                    th:text="${student.fullName + ' (' + student.email + ')'}">Student</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-person-plus me-1"></i> Enroll Student
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/subject-classroom.js}"></script>
<script>
    function validatePct(input) {
        const form = input.closest('form');
        const easy = parseInt(form.querySelector('[name="easyPercent"]').value) || 0;
        const medium = parseInt(form.querySelector('[name="mediumPercent"]').value) || 0;
        const hard = parseInt(form.querySelector('[name="hardPercent"]').value) || 0;
        const errDiv = form.querySelector('.pct-error');
        const submitBtn = document.getElementById('distributeSubmitBtn');
        if (easy + medium + hard !== 100) {
            errDiv.classList.remove('d-none');
            submitBtn.disabled = true;
        } else {
            errDiv.classList.add('d-none');
            updateDistributeBtnState();
        }
    }

    function applyDeadlinePreset(select) {
        const form = select.closest('form');
        const deadlineInput = form.querySelector('.deadline-input');
        if (select.value === 'custom') {
            deadlineInput.value = '';
        } else {
            const now = new Date();
            now.setHours(now.getHours() + parseInt(select.value));
            const pad = n => String(n).padStart(2, '0');
            deadlineInput.value = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        }
    }

    const modalSelectAllStudents = document.getElementById('modalSelectAllStudents');
    const modalStudentChecks = () => [...document.querySelectorAll('.modal-student-checkbox')];
    const modalSelectedCount = document.getElementById('modalSelectedCount');
    const distributeSubmitBtn = document.getElementById('distributeSubmitBtn');
    const examSelect = document.getElementById('examSelect');
    const questionCountInput = document.getElementById('questionCountInput');
    const questionCountHint = document.getElementById('questionCountHint');
    const manageSelectedQuizBtn = document.getElementById('manageSelectedQuizBtn');
    const distributeQuizModalEl = document.getElementById('distributeQuizModal');
    const distributeQuizForm = document.getElementById('distributeQuizForm');
    const modalDraftKey = `distributeQuizDraft:${window.location.pathname}`;

    function saveDistributeModalDraft() {
        if (!distributeQuizForm) return;

        const easyInput = distributeQuizForm.querySelector('[name="easyPercent"]');
        const mediumInput = distributeQuizForm.querySelector('[name="mediumPercent"]');
        const hardInput = distributeQuizForm.querySelector('[name="hardPercent"]');
        const deadlineInput = distributeQuizForm.querySelector('.deadline-input');
        const presetInput = distributeQuizForm.querySelector('.deadline-preset');

        const payload = {
            examId: examSelect ? examSelect.value : '',
            questionCount: questionCountInput ? questionCountInput.value : '',
            easyPercent: easyInput ? easyInput.value : '',
            mediumPercent: mediumInput ? mediumInput.value : '',
            hardPercent: hardInput ? hardInput.value : '',
            deadline: deadlineInput ? deadlineInput.value : '',
            deadlinePreset: presetInput ? presetInput.value : '',
            selectedStudents: modalStudentChecks().filter(cb => cb.checked).map(cb => cb.value)
        };

        sessionStorage.setItem(modalDraftKey, JSON.stringify(payload));
    }

    function restoreDistributeModalDraft() {
        const draftRaw = sessionStorage.getItem(modalDraftKey);
        if (!draftRaw) return;

        try {
            const draft = JSON.parse(draftRaw);
            if (examSelect && typeof draft.examId === 'string') {
                examSelect.value = draft.examId;
            }
            if (questionCountInput && draft.questionCount !== undefined) {
                questionCountInput.value = draft.questionCount;
            }

            const easyInput = distributeQuizForm ? distributeQuizForm.querySelector('[name="easyPercent"]') : null;
            const mediumInput = distributeQuizForm ? distributeQuizForm.querySelector('[name="mediumPercent"]') : null;
            const hardInput = distributeQuizForm ? distributeQuizForm.querySelector('[name="hardPercent"]') : null;
            const deadlineInput = distributeQuizForm ? distributeQuizForm.querySelector('.deadline-input') : null;
            const presetInput = distributeQuizForm ? distributeQuizForm.querySelector('.deadline-preset') : null;

            if (easyInput && draft.easyPercent !== undefined) easyInput.value = draft.easyPercent;
            if (mediumInput && draft.mediumPercent !== undefined) mediumInput.value = draft.mediumPercent;
            if (hardInput && draft.hardPercent !== undefined) hardInput.value = draft.hardPercent;
            if (presetInput && draft.deadlinePreset !== undefined) presetInput.value = draft.deadlinePreset;
            if (deadlineInput && draft.deadline !== undefined) deadlineInput.value = draft.deadline;

            const selected = new Set(Array.isArray(draft.selectedStudents) ? draft.selectedStudents : []);
            modalStudentChecks().forEach(cb => {
                cb.checked = selected.has(cb.value);
            });
        } catch (e) {
            sessionStorage.removeItem(modalDraftKey);
        }
    }

    function checkedStudentsCount() {
        return modalStudentChecks().filter(cb => cb.checked).length;
    }

    function updateSelectedCountBadge() {
        const count = checkedStudentsCount();
        if (modalSelectedCount) {
            modalSelectedCount.textContent = `${count} selected`;
        }
        if (modalSelectAllStudents) {
            const total = modalStudentChecks().length;
            modalSelectAllStudents.indeterminate = count > 0 && count < total;
            modalSelectAllStudents.checked = total > 0 && count === total;
        }
    }

    function updateQuestionCountBounds() {
        if (!examSelect || !questionCountInput || !questionCountHint) return;
        const option = examSelect.options[examSelect.selectedIndex];
        const max = option ? parseInt(option.getAttribute('data-question-count') || '0') : 0;

        if (!max || isNaN(max)) {
            questionCountInput.min = 1;
            questionCountInput.max = 1;
            questionCountInput.value = 1;
            questionCountHint.textContent = 'Select an exam first.';
        } else {
            questionCountInput.min = 1;
            questionCountInput.max = max;
            if (parseInt(questionCountInput.value || '1') > max) {
                questionCountInput.value = max;
            }
            if (parseInt(questionCountInput.value || '1') < 1) {
                questionCountInput.value = 1;
            }
            questionCountHint.textContent = `Max: ${max} question(s)`;
        }
    }

    function updateDistributeBtnState() {
        if (!distributeSubmitBtn) return;

        const count = checkedStudentsCount();
        const hasExam = examSelect && examSelect.value;
        const pctErrorVisible = document.querySelector('#distributeQuizForm .pct-error:not(.d-none)') !== null;

        distributeSubmitBtn.disabled = !(count > 0 && hasExam && !pctErrorVisible);
    }

    function updateManageQuizButton() {
        if (!manageSelectedQuizBtn) return;
        const examId = examSelect && examSelect.value ? examSelect.value : '';
        if (!examId) {
            manageSelectedQuizBtn.classList.add('disabled');
            manageSelectedQuizBtn.setAttribute('aria-disabled', 'true');
            return;
        }
        manageSelectedQuizBtn.classList.remove('disabled');
        manageSelectedQuizBtn.setAttribute('aria-disabled', 'false');
    }

    function syncDistributeModalState() {
        updateSelectedCountBadge();
        updateQuestionCountBounds();
        updateDistributeBtnState();
        updateManageQuizButton();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.deadline-preset').forEach(sel => applyDeadlinePreset(sel));

        if (examSelect) {
            examSelect.addEventListener('change', () => {
                updateQuestionCountBounds();
                updateDistributeBtnState();
                updateManageQuizButton();
                saveDistributeModalDraft();
            });
        }

        if (manageSelectedQuizBtn) {
            manageSelectedQuizBtn.addEventListener('click', function () {
                const examId = examSelect && examSelect.value ? examSelect.value : '';
                if (!examId) {
                    alert('Please select a processed exam first.');
                    return;
                }
                saveDistributeModalDraft();
                const returnTo = `${window.location.pathname}?reopenDistributeModal=1`;
                window.location.href = `/teacher/manage-questions/${encodeURIComponent(examId)}?returnTo=${encodeURIComponent(returnTo)}`;
            });
        }

        if (modalSelectAllStudents) {
            modalSelectAllStudents.addEventListener('change', function () {
                modalStudentChecks().forEach(cb => cb.checked = this.checked);
                updateSelectedCountBadge();
                updateDistributeBtnState();
                saveDistributeModalDraft();
            });
        }

        modalStudentChecks().forEach(cb => {
            cb.addEventListener('change', () => {
                updateSelectedCountBadge();
                updateDistributeBtnState();
                saveDistributeModalDraft();
            });
        });

        if (distributeQuizForm) {
            distributeQuizForm.addEventListener('input', saveDistributeModalDraft);
            distributeQuizForm.addEventListener('change', saveDistributeModalDraft);
        }

        syncDistributeModalState();

        if (distributeQuizModalEl) {
            distributeQuizModalEl.addEventListener('show.bs.modal', syncDistributeModalState);
            distributeQuizModalEl.addEventListener('shown.bs.modal', syncDistributeModalState);
        }

        window.addEventListener('pageshow', syncDistributeModalState);

        const url = new URL(window.location.href);
        if (url.searchParams.get('reopenDistributeModal') === '1' && distributeQuizModalEl) {
            restoreDistributeModalDraft();
            syncDistributeModalState();
            const modalInstance = bootstrap.Modal.getOrCreateInstance(distributeQuizModalEl);
            modalInstance.show();
            url.searchParams.delete('reopenDistributeModal');
            const cleanSearch = url.searchParams.toString();
            window.history.replaceState({}, document.title, `${url.pathname}${cleanSearch ? '?' + cleanSearch : ''}${url.hash}`);
        }

        // Students & Grades search
        const searchInput = document.getElementById('classroomStudentSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const q = this.value.toLowerCase().trim();
                document.querySelectorAll('#classroomStudentPanelList .student-panel').forEach(panel => {
                    const key = panel.dataset.searchKey || '';
                    panel.style.display = (!q || key.includes(q)) ? '' : 'none';
                });
            });
        }

        const enrollSearchInput = document.getElementById('enrollStudentSearch');
        const enrollSelect = document.getElementById('enrollStudentSelect');
        if (enrollSearchInput && enrollSelect) {
            enrollSearchInput.addEventListener('input', function () {
                const query = this.value.toLowerCase().trim();
                const options = Array.from(enrollSelect.options);
                options.forEach((option, index) => {
                    if (index === 0) return;
                    const text = (option.text || '').toLowerCase();
                    const value = (option.value || '').toLowerCase();
                    const matches = !query || text.includes(query) || value.includes(query);
                    option.hidden = !matches;
                });

                const currentOption = enrollSelect.options[enrollSelect.selectedIndex];
                if (currentOption && currentOption.hidden) {
                    enrollSelect.value = '';
                }
            });
        }

        // Chevron rotate on collapse
        document.querySelectorAll('.student-panel-header').forEach(header => {
            const target = document.querySelector(header.dataset.bsTarget);
            if (!target) return;
            target.addEventListener('show.bs.collapse', () => {
                const icon = header.querySelector('.bi-chevron-down');
                if (icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
            });
            target.addEventListener('hide.bs.collapse', () => {
                const icon = header.querySelector('.bi-chevron-up');
                if (icon) icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
            });
        });
    });
</script>
</body>
</html>
